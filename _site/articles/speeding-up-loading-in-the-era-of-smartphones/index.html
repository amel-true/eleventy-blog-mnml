<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="Description" content="Гонка за скоростью: ускоряем загрузку сайтов в эпоху смартфонов" />
    <title>Гонка за скоростью: ускоряем загрузку сайтов в эпоху смартфонов</title>
    <link
      href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../styles/common.css" />
    <link rel="stylesheet" href="../../styles/article.css" />
    <link rel="stylesheet" href="../../styles/prism-theme.css"/>
  </head>
  <body>
    <div class="container article-container">
        <h1>Гонка за скоростью: ускоряем загрузку сайтов в эпоху смартфонов</h1>
      <div class='content'><p><img src="https://cdn-images-1.medium.com/max/800/1*5XLwaxHp9Yk6xUrqr7PCKg.png" alt=""></p>
<p>Смартфоны давно стали частью нашей жизни. Мы просыпаемся утром и проверяем социальные сети, читаем почту, открываем ссылки. Мы живём в эпоху смартфонов, начавшуюся в 2007 году, когда Стив Джобс вышел на сцену в Сан-Франциско и показал первый iPhone. Это был телефон, в который тогда мало кто верил, у которого даже не было возможности установки приложений. Однако уже тогда в нём был прекрасный браузер, которым можно было управлять без стилуса и который позволял с относительным удобством читать <em>обычные</em> сайты. Через год вышла первая версия Android, впитавшая и переосмыслившая идеи iPhone. И вот тогда, когда простые люди (не гики с КПК и коммуникаторами) отложили в сторону свои устаревшие кнопочные телефоны, тогда и началось победное шествие мобильного Интернета.</p>
<p>Спустя несколько лет это привело к тому, что мобильный трафик превысил десктопный. А вместе с этим событием мобильный Интернет прекратил своё существование. Мобильный Интернет перестал быть подмножеством Большого Интернета, он и есть Самый Настоящий Интернет. Уже не существует Mobile First, перед нами просто разные размеры экранов и разные каналы связи и все они должны обеспечивать одинаково хороший пользовательский опыт.</p>
<p>В этой статье я расскажу о том, какие современные средства существуют для того, чтобы улучшить пользовательский опыт для вашего сайта.</p>
<h2>Метрики</h2>
<blockquote>
<p>В 53% случаев пользователи отказываются от дальнейшей загрузки мобильного сайта, если она требует более 3-х секунд ожидания.</p>
<p>Каждый второй пользователь ожидает, что страница загрузится менее чем за 2 секунды.<br>
<a href="bit.ly/mobile-speed1">bit.ly/mobile-speed1</a></p>
</blockquote>
<p>Это тайминги, о которых мы должны помнить. Но возникает вопрос, что значит это понятие «Сайт загрузился»? В какой момент времени мы можем так сказать? Существуют три наиболее важные метрики:</p>
<ol>
<li>Первое отображение (First Paint)</li>
<li>Первое значимое отображение (First Meaningful Paint)</li>
<li>Первая интерактивность (First Interactive)</li>
</ol>
<p><strong>Первое отображение</strong> — на вашем сайте что-то появилось. Это уже не пустая белая страница, пользователь понимает, что всё работает.</p>
<p><strong>Первое значимое отображение</strong> — на вашем сайте появилось что-то полезное, пользователь может начать им пользоваться, например, читать текст.</p>
<p><strong>Первая интерактивность</strong> — все скрипты проинициализированы и можно начать пользоваться интерактивными элементами. Обычно это можно отследить по падению загрузки процессора.</p>
<p>За этими метриками можно следить в Chrome DevTools, используя вкладку <strong>Performace</strong>. Это достаточно наглядный способ, но предназначен он скорее для отладки, а не для предрелизного и пострелизного аудита.</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*-sd0XMhxL44yvrnAN-LtTg.png" alt=""></p>
<p>В случае ручного снятия метрик всегда нужно помнить о том, что ваши пользователи со смартфонами используют зачастую достаточно ненадёжный и медленный канал, а так же устройства с не самыми быстрыми процессорами. Для эмуляции такого поведения Google Chrome предоставляет инструменты троттлинга канала и процессора:</p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*Sbc8u2rp7SsBQAHaVYE-AA.png" alt=""></p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*UOHwhOBYqpHo72KRX9Qe2w.png" alt=""></p>
<p>Более удобный подход даёт нам использование <a href="https://developers.google.com/web/tools/lighthouse/">Google Lighthouse</a> — инструмента для комплексного аудита сайта. Нажимаем одну кнопку, ждём несколько секунд и получаем все метрики.</p>
<p><img src="https://developers.google.com/web/tools/lighthouse/images/report.png" alt=""></p>
<p>Однако при CI хотелось бы автоматизировать снятие метрик. На помощь могут прийти как сторонние инструменты, такие как <a href="calibreapp.com">calibreapp.com</a>, способные автоматически анализировать заданный сайт и оповещать в случае превышения заданного бюджета для каждой из метрик, так и собственные решения, построенные на <a href="https://developer.mozilla.org/ru/docs/Web/API/Navigation_timing_API">Navigation Timing API</a>. Второй вариант наиболее интересен, так как отражает реальные проблемы реальных пользователей вашего сайта.</p>
<h2>Этапы получения веб-страницы</h2>
<p>Получение и отрисовка страницы на сайте происходит в несколько этапов.</p>
<h3>Запрос данных с сервера</h3>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*6RTdXK1VhUfl6jhwfdU_uA.png" alt=""></p>
<p>Смартфон устанавливает сетевое соединение с сервером и получает HTML.</p>
<h3>Получение ресурсов из HTML</h3>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*Y91UODRMM3s69STy_-Lu_Q.gif" alt=""></p>
<p>Браузер анализирует HTML в потоковом режиме и ставит обнаруженные ресурсы в очередь. Все ресурсы получают приоритеты загрузки в зависимости от своего типа: <strong>Lowest</strong>, <strong>Low</strong>, <strong>Medium</strong>, <strong>High</strong> и <strong>Highest</strong>. Подробнее о приоритетах загрузки ресурсов можно прочитать в <a href="https://medium.com/devschacht/the-critical-request-ac20b5267e4a">статье Бена Шварца «Критический запрос»</a>.</p>
<h3>Разбор JavaScript и CSS</h3>
<ul>
<li>JavaScript - парсинг и компиляция</li>
<li>CSS - наложение стилей, рендер</li>
</ul>
<blockquote>
<p>Даже если ваш CSS-файл ссылается на шрифт @font-face, он не будет запрашиваться до тех пор, пока этот шрифт не будет использован в селекторе, а этот селектор будет соответствовать элементу на странице.<br>
<a href="https://medium.com/devschacht/the-critical-request-ac20b5267e4a">«Критический запрос»</a></p>
</blockquote>
<h2>Начинаем ускорять: оптимизация порядка доставки ресурсов</h2>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*N8ZwYztJimjfSmdlctaZsQ.png" alt=""></p>
<p>Если мы посмотрим на график загрузки ресурсов, то увидим, что он хаотичен и ресурсы, необходимые в первую очередь (например, шрифты) могут быть расположены на таймлайне весьма далеко от начала запроса. К счастью, у нас есть замечательный способ для управления порядком загрузки ресурсов — <code>&lt;link rel=&quot;preload&quot;&gt;</code>. Мы можем с помощью тега <code>&lt;link&gt;</code> передать браузеру список необходимых ресурсов, которые нам <strong>понадобятся позднее</strong>. Таким образом, мы можем указать наш загружаемый шрифт и браузер добавит его в очередь загрузки ещё до того, как начнёт анализировать css.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>//yastatic.net/islands/_/GEumJGdz6PuI2jZ6GhSq0paPvho.woff2<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font/woff2<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span></code></pre>
<p>С помощью атрибута <code>as=&quot;font&quot;</code> мы подсказываем браузеру, что это шрифт и его необходимо загружать с высшим приоритетом.</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*torQAocGkw_Gjn9Sm3LNHQ.png" alt=""></p>
<p>Можно заметить, что шрифт начинает загружаться сразу после загрузки HTML. Инициировать предварительную загрузку ресурсов можно не только внутри HTML, но и с помощью HTTP-заголовков.</p>
<pre><code>Link: &lt;//yastatic.net/islands/_/GEumJGdz6PuI2jZ6GhSq0paPvho.woff2&gt;; rel=preload; as=font
</code></pre>
<h3>font-display</h3>
<p>Однако у нас всё равно остаётся момент, когда браузер отображает страницу без текста, ожидая загрузки шрифта. К счастью, современные браузеры <a href="http://caniuse.com/#search=font-display">начали внедрение</a> замечательного CSS-правила <strong>font-display</strong>.</p>
<p>Наиболее полезно для нас его значение <code>font-display: swap</code>, которое говорит браузеру, что необходимо сначала показать текст имеющимся шрифтом, а после того как загрузится нужный — подменить на него. <code>font-display: fallback</code> работает ещё более хитро — это правило командует браузеру подождать небольшой период времени (100мс для Google Chrome) и если шрифт не загрузился, отобразить текст имеющимся в системе шрифтом, без подмены на загруженный позднее.</p>
<h2>Протокол прикладного уровня</h2>
<p>Как бы мы не старались оптимизировать приоритеты загрузки, мы всё равно можем заметить, что ресурсы начинают загружаться в разное время, даже если имеют одинаковый приоритет и встали в очередь одновременно.</p>
<p><img src="https://cdn-images-1.medium.com/max/1000/1*RVVOv85QtAq2K0V4exwhFw.png" alt=""></p>
<p>Это связано с тем, что браузеры имеют ограничение по количеству параллельных запросов на один домен (в среднем около шести параллельных запросов). Раньше это ограничение обходили, разнося статику по нескольким доменам третьего уровня или вынося её в CDN, что, очевидно, не всегда удобно и доступно (хотя и очень эффективно).</p>
<p>Однако с 2015 года у нас есть протокол HTTP/2, пришедший на смену устаревшему HTTP1.1, который не обновлялся с 1999 года. Протокол <a href="https://ru.wikipedia.org/wiki/HTTP/2">HTTP/2</a> основан на представленном Google в 2012 году протоколе <a href="https://ru.wikipedia.org/wiki/SPDY">SPDY</a>, разработка и поддержка которого на данный момент <a href="http://web.archive.org/web/20150310025724/http://blog.chromium.org/2015/02/hello-http2-goodbye-spdy-http-is_9.html">прекращены</a>. Наиболее интересно для нас сейчас то, что протокол является бинарным и поддерживает мультиплексирование запросов и ответов — иначе говоря параллельную передачу нескольких запросов в одном TCP-соединении.</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*2f7kJCYLFVJiMUCevh2bgw.png" alt=""></p>
<h3>Node.js 8.4.0 ❤️ HTTP/2</h3>
<p>Не так давно вышла Node.js версии 8.4.0, включающая в себя экспериментальную поддержку HTTP/2. Это позволяет нам поэкспериментировать с новым протоколом, не подключая никаких дополнительных пакетов. Попробуем написать небольшой сервер, используя новые возможности и новое API.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> http2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><br>	key<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'key.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>	cert<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'cert.pem'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> mimeType <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token string">'.ico'</span><span class="token operator">:</span> <span class="token string">'image/x-icon'</span><span class="token punctuation">,</span><br>	<span class="token string">'.html'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span><br>	<span class="token string">'.js'</span><span class="token operator">:</span> <span class="token string">'text/javascript'</span><span class="token punctuation">,</span><br>	<span class="token string">'.json'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span><br>	<span class="token string">'.css'</span><span class="token operator">:</span> <span class="token string">'text/css'</span><span class="token punctuation">,</span><br>	<span class="token string">'.png'</span><span class="token operator">:</span> <span class="token string">'image/png'</span><span class="token punctuation">,</span><br>	<span class="token string">'.jpg'</span><span class="token operator">:</span> <span class="token string">'image/jpeg'</span><span class="token punctuation">,</span><br>	<span class="token string">'.wav'</span><span class="token operator">:</span> <span class="token string">'audio/wav'</span><span class="token punctuation">,</span><br>	<span class="token string">'.mp3'</span><span class="token operator">:</span> <span class="token string">'audio/mpeg'</span><span class="token punctuation">,</span><br>	<span class="token string">'.svg'</span><span class="token operator">:</span> <span class="token string">'image/svg+xml'</span><span class="token punctuation">,</span><br>	<span class="token string">'.pdf'</span><span class="token operator">:</span> <span class="token string">'application/pdf'</span><span class="token punctuation">,</span><br>	<span class="token string">'.doc'</span><span class="token operator">:</span> <span class="token string">'application/msword'</span><span class="token punctuation">,</span><br>	<span class="token string">'.eot'</span><span class="token operator">:</span> <span class="token string">'appliaction/vnd.ms-fontobject'</span><span class="token punctuation">,</span><br>	<span class="token string">'.ttf'</span><span class="token operator">:</span> <span class="token string">'aplication/font-sfnt'</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> server <span class="token operator">=</span> http2<span class="token punctuation">.</span><span class="token function">createSecureServer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stream<span class="token punctuation">,</span> headers</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>headers<span class="token punctuation">[</span><span class="token string">':method'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>headers<span class="token punctuation">[</span><span class="token string">':path'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// parse URL</span><br>  <span class="token keyword">const</span> parsedUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token string">':path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// extract URL path</span><br>  <span class="token keyword">let</span> pathname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parsedUrl<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">.</span>ext<span class="token punctuation">;</span><br>  <span class="token comment">// maps file extention to MIME types</span><br>  fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exist</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token comment">// if the file is not found, return 404</span><br>			stream<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">':status'</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>			stream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">File </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>			<span class="token keyword">return</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><br><br>		<span class="token comment">// if is a directory, then look for index.html</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			pathname <span class="token operator">+=</span> <span class="token string">'/index.html'</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><br><br>		<span class="token keyword">const</span> indexPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>indexPath<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			stream<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'content-type'</span><span class="token operator">:</span> mimeType<span class="token punctuation">[</span>ext<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span> <span class="token string">':status'</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>			readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>		readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			stream<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">':status'</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>			stream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error getting the file: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8800</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Запускаем наш сервер с ключом <code>--expose-http2</code>:</p>
<pre><code>node --expose-http2 server.js
</code></pre>
<p>И видим совершенно другие результаты, ресурсы загружаются параллельно!</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*wy8XexXbh0BFSb9_RllDDw.png" alt=""></p>
<p>Обратите внимание, все ресурсы (кроме внешних) имеют один Connection ID.</p>
<h3>Push me!</h3>
<p>Другая интересная технология, появившаяся в HTTP/2 — это Server Push. Как видно на графике, мы всё равно продолжаем ожидать окончания загрузки html, чтобы перейти к стадии загрузки ресурсов. Технология Server Push позволяет начать загрузку необходимых ресурсов <strong>одновременно</strong> с загрузкой html.</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*k7MDRXk_HOHHwIopjBRqWw.png" alt=""></p>
<p>Давайте научим наш сервер отдавать <code>common.css</code> через Server Push.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> server <span class="token operator">=</span> http2<span class="token punctuation">.</span><span class="token function">createSecureServer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> commonCSS <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'common.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stream<span class="token punctuation">,</span> headers</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>headers<span class="token punctuation">[</span><span class="token string">':method'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>headers<span class="token punctuation">[</span><span class="token string">':path'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> parsedUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token string">':path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> pathname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parsedUrl<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">.</span>ext<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token string">':path'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'/index.html'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	stream<span class="token punctuation">.</span><span class="token function">pushStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">':path'</span><span class="token operator">:</span> <span class="token string">'common.css'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">pushStream</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>		pushStream<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">':status'</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/css'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		pushStream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>commonCSS<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> indexPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>indexPath<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		stream<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'content-type'</span><span class="token operator">:</span> mimeType<span class="token punctuation">[</span>ext<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span> <span class="token string">':status'</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>	  <span class="token comment">// остальная статика</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8800</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Что здесь происходит? В тот момент, когда пользователь запрашивает <code>index.html</code>, сервер одновременно начинает отдавать ему <code>common.css</code>, и когда браузер начнёт анализировать HTML и дойдёт до необходимости загрузки css, файл уже будет частично (или даже полностью) загружен!</p>
<h3>Подводные камни Server Push</h3>
<p>Джейк Арчибальд написал замечательную статью <a href="https://habrahabr.ru/company/badoo/blog/331216/">«HTTP/2 Server Push не так прост, как я думал»</a>, в которой рассматривает множество проблем, имеющихся у Server Push на текущий момент. Наиболее важный для нас вопрос — это вопрос кэширования ресурсов. Действительно, в приведённой выше реализации сервера получается, что мы получаем <code>common.css</code> каждый раз, когда запрашиваем <code>index.html</code>, даже если <code>common.css</code> уже есть в кеше браузера. Для обхода этого ограничения есть несколько техник.</p>
<h3>Печеньки!</h3>
<p>Удивительно простое решение, которое поддерживается готовыми HTTP/2 серверами, такими как <a href="https://h2o.examp1e.net/">H2O</a>. После первичной загруски, клиент ставит сookie, в которой записывает факт загрузки и кэширования ресурсов текущей версии. Основываясь на этой cookie, сервер принимает решение о том, необходим ли Server Push.</p>
<h3>Server Push ❤️ Service Worker</h3>
<p>Более интересное решение доступно владельцам Android (а в скором времени и iOS) — это технология <a href="https://medium.com/high-technologies-center/%D0%BA%D1%82%D0%BE-%D1%82%D1%8B-%D1%82%D0%B0%D0%BA%D0%BE%D0%B9-service-worker-9bce3b1201b6">сервис-воркеров</a>.</p>
<p>Давайте напишем небольшой сервис-воркер, который будет жить в браузере мобильного телефона и держать в себе кэш всех необходимых ресурсов.</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*MLT0qPGJ1JqTyC_mwmXNfQ.png" alt=""></p>
<p>Этот сервис-воркер имеет довольно простой код:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">'v1'</span><span class="token punctuation">;</span><br><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><br>    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>        <span class="token string">'index.html'</span><span class="token punctuation">,</span><br>        <span class="token string">'common.css'</span><br>      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">u</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token punctuation">{</span> credentials<span class="token operator">:</span> <span class="token string">'include'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SW Fetching... '</span><span class="token punctuation">)</span><br>  <span class="token keyword">let</span> response<span class="token punctuation">;</span><br>  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> cachedResponse <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResponse<span class="token punctuation">)</span> <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span><br>    response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>При первом заходе на сайт пользователь получает код сервис-воркера, который кэширует полученные через Server Push ресурсы и начинает слушать событие <code>fetch</code>. Как только браузер запрашивает какой-то ресурс, сервис-воркер проверяет, нет ли у него в кэше этого ресурса и отдаёт его при наличии (либо кэширует при отсутствии). Что наиболее интересно, при следующем заходе на страницу браузер уже не будет запрашивать с сервера <code>index.html</code> — он возьмёт его из своего кэша. А значит не будет инициирован Server Push и, что ещё более интересно, вам вообще не понадобится сетевое соединение, чтобы посмотреть последнюю загруженную версию сайта!</p>
<p>Как можно заметить из приведённого кода, в случае загрузки сервис-воркера с новым <code>cacheName</code> мы получим полный сброс кэшей. Это не очень хорошая стратегия и реальной жизни лучше подумать над инкрементальным обновлением.</p>
<p>Посмотрим на графики загрузки:</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*CbtotmwtPQMJPlDFyPzbUA.png" alt=""></p>
<p>Выглядит просто отлично!</p>
<h2>Оптимизация JavaScript</h2>
<p>Не вдаваясь в подробности оптимизации парсинга JavaScript кода (такие, как например, <a href="https://medium.com/devschacht/lazy-javascript-parsing-in-v8-99b5c3a6cbba">принудительный обход ленивого парсинга</a>), можно дать один важный совет — уменьшайте размер вашего JavaScript-бандла. Это важно не только для скорости его загрузки, но и для уменьшения времени парсинга.</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*2rOxJHggNE9JJLEJGqI8cA.png" alt=""></p>
<p>Почему размер бандла так важен? Ответ в том, что не все пользователи ходят с последними моделями телефонов.</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*aVyTLq7bPe4cimVOz4jqdg.png" alt=""></p>
<p><a href="https://docs.google.com/spreadsheets/d/1wHcNNQea28LhwQ_amFamT33d5woVrJfJy53Z1k6V090/edit#gid=1882596388">https://docs.google.com/spreadsheets/d/1wHcNNQea28LhwQ_amFamT33d5woVrJfJy53Z1k6V090/edit#gid=1882596388</a></p>
<p>Используйте такие утилиты, как <a href="https://www.npmjs.com/package/webpack-bundle-analyzer">webpack-bundle-analyzer</a> для того, чтобы разобраться, что же делает ваш бандл таким большим.</p>
<p><img src="https://cloud.githubusercontent.com/assets/302213/20628702/93f72404-b338-11e6-92d4-9a365550a701.gif" alt=""></p>
<p>Разбивайте ваш код на несколько бандлов и подгружайте их по мере необходимости.</p>
<h2>Выводы</h2>
<ul>
<li>Используйте preload и font-display:swap</li>
<li>Используйте HTTP/2</li>
<li>Попробуйте Server Push и Service Workers</li>
<li>Уменьшайте ваши бандлы</li>
<li>Тестируйте на реальных устройствах в реальной сети</li>
</ul>
<hr>
<p>На написание этой статьи меня сподвиг замечательный доклад <a href="https://twitter.com/samccone">@samccone</a> : <a href="https://www.youtube.com/watch?v=RWLzUnESylc">Planning for Performance</a><br>
Использованы некоторые слайды из моего доклада на <a href="https://events.yandex.ru/events/meetings/29-august-2017/">Frontend Mix</a>.<br>
Большое спасибо <a href="https://github.com/maksugr">@maksugr</a> за редактуру</p>
<hr>
</div>
      <div class="back-link">
        <a href="/">← Back</a>
      </div>
    </div>
  </body>
</html>
